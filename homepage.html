<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>HOME</title>
       

         <!-- 모달 -->
         <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
         <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
         <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
         <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>

       
        <!--폰트-->
        <link rel="stylesheet" href="https://unpkg.com/@kfonts/nanum-handwritting-neulisneulische/index.css" />

        <!-- CSS -->
        <style>
            body {background-image:url("./img/background.png"); background-position:top; background-repeat: no-repeat; background-size: 100% 100%;
                text-align: center; font-family: "나눔손글씨 느릿느릿체", "나눔손글씨느릿느릿체", "nanum-handwritting-neulisneulische";}
            h1 {margin:2%; padding:2%; font-size:50px;}
            div {margin:3%; padding:2%; font-size:20px;}

            
            .homepage_image {width:10%; height:10%;}
            .homepage_button_image {width:100%; height:100%;}
            .homepage_button {width:50%; height:30%; background-color:white; border:none;}
            .historycheckpage_button {background-color:#C4DEEE; color:#9979C1; width:40%; padding:3%; border-style:none; border-radius:30px; font-size:20px; font-weight:bold;}
            .table{margin-left:10px; margin-right: 65px; size: 50px;}
            #modal_show{background-color:#C4DEEE; color:#9979C1; width:40%; padding:3%; border-style:none; border-radius:30px; font-size:20px; font-weight:bold;}  
        
            #statusTable th { width: 100px; }
        </style>
        <!--아이콘-->
        <script src="https://kit.fontawesome.com/b2aa12ea51.js" crossorigin="anonymous"></script>
       
        
    </head>

    <body>
       
        <h1>IoT 원격 사료 배식 서비스</h1>

        <!-- 사용자 정보 조회 하려니 람다함수랑 API 또 만들어야 해서 다른 것 먼저 하고 시간 남으면 하려고 주석처리 해놓음 -->

      <!--DB에서 값가죠오는 코드 필요-->
         <!-- <button type="button" class="btn btn-primary" id="modal_show">  
            <p>사용자 정보 조회</p>
        </button> -->

        <!-- Modal -->
        <!-- <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">사용자 정보</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <table border= 1; class="table">
                                <tr>
                                    <th>이름</th>
                                    <td id="user_name">관리자</td>
                                </tr>
                                <tr>
                                    <th>id</th> 
                                    <td id="user_id">001</td>
                                </tr>
                                <tr>
                                    <th>비밀번호</th>    
                                    <td id="user_password">00012</td>
                                </tr>
                        
                            </tr>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                       
                    </div>
                </div>
            </div>
        </div> -->
        <!-- <script>
            $(document).ready(function() {
                $("#modal_show").click(function() {
                    $("#exampleModal").modal("show");
                });
     
                $("#close_modal").click(function() {
                    $("#exampleModal").modal("hide");
                });
            });
        </script> -->

        <!--기록조회 버튼-->
        <div>
            <button class="historycheckpage_button" value="사용자정보 조회하기" onclick="userModalOpen()">사용자정보 조회</button>
        </div>
  
        <!--기록조회 버튼-->
        <div>
            <button class="historycheckpage_button" value="이슈기록 조회하기" onclick="window.location.href='./menu.html'">기록 조회</button>
        </div>

        <!--현재상태 확인 및 사료주기-->
        <div>
            <!-- <button class="historycheckpage_button" value="사료주기" onclick="window.location.href='./nowpage.html'">상태확인 및 사료주기</button> -->
            <button class="historycheckpage_button" value="사료주기" onclick="statusModalOpen()">상태확인 및 사료주기</button>
        </div>

        <!-- 상태확인 및 사료주기 Modal -->
        <div class="modal fade" id="statusModal" tabindex="-1" role="dialog" aria-labelledby="statusModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="statusModalLabel">상태 조회 및 배식</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <table class="table table-bordered" id="statusTable" width="100%" cellspacing="0">
                            <tr>
                                <th>온도</th>
                                <td id="td_temp"></td>
                            </tr>
                            <tr>
                                <th>습도</th>
                                <td id="td_humi"></td>
                            </tr>
                            <tr>
                                <th>잔량</th>
                                <td id="td_cm"></td>
                            </tr>
                        </table>   
                        <button type="button" class="d-none d-inline-block btn btn btn-primary" onclick="feed()" style="width: 200px; margin-top: 20px;">사료 배식</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 사용자정보 조회 Modal -->
        <div class="modal fade" id="userModal" tabindex="-1" role="dialog" aria-labelledby="userModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="userModalLabel">사용자정보 조회</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <table class="table table-bordered" id="userTable" width="100%" cellspacing="0">
                            <tr>
                                <th>이름</th>
                                <td id="td_name"></td>
                            </tr>
                            <tr>
                                <th>ID</th>
                                <td id="td_id"></td>
                            </tr>
                            <tr>
                                <th>비밀번호</th>
                                <td id="td_password"></td>
                            </tr>
                        </table>                 
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                       
                    </div>
                </div>
            </div>
        </div>

        <script>
            function statusModalOpen(){
                setStatusModalData();       // API 응답 받고 나서 모달 열림
            }
            function statusModalClose(){
                $("#statusModal").modal("hide");
            }

            // 스테이터스 모달 값(현재온도, 현재습도, 현재잔량) 셋팅 함수
            function setStatusModalData(){

                console.log("setStatusModalData() 호출");

                // 디바이스 상태 조회 URI
                let uri = 'https://3fpdmaspi2.execute-api.ap-northeast-2.amazonaws.com/pet/devices/MKR2';       

                $.ajax(uri, {
                    method: 'GET',
                    contentType: "application/json",

                    success: function (data, status, xhr) {
                            var result = JSON.parse(data);
                            console.log(result.state.reported);

                            let now_temp = result.state.reported.temperature;
                            let now_humi = result.state.reported.humidity;
                            let now_cm = result.state.reported.cm;

                            $('#td_temp').text(now_temp);
                            $('#td_humi').text(now_humi);
                            $('#td_cm').text(now_cm);

                            $("#statusModal").modal("show");
                    },
                    error: function(xhr,status,e){
                            alert("error");
                    }
                });
            }

            // 사료 배식 API 호출 함수
            function feed(){
                console.log("feed() 호출");

                // 모터 ON 하고 3초 후에 OFF 하는 방식으로 배식기 입구 제어
                controlMotor("ON");
                setTimeout(function() {
                    controlMotor("OFF");
                }, 3000);
                
            }

            // 모터 제어 함수 (what : ON/OFF 두 개의 상태 값 중 하나를 인자로 받음)
            function controlMotor(what){            
                console.log("petMotorOn() 호출 : " + what);

                // 디바이스 상태 변경 URI
                let uri = 'https://3fpdmaspi2.execute-api.ap-northeast-2.amazonaws.com/pet/devices/MKR2'; 
                let item = {
                    "tags" : [
                            {
                                "tagName": "MOTOR",
                                "tagValue": what
                            }   
                    ]
                };

                $.ajax(uri, {
                    method: 'PUT',
                    contentType: "application/json",
                    body: item,
                    data: JSON.stringify(item),

                    success: function (data, status, xhr) {
                            var result = JSON.parse(data);
                            console.log(result);

                    },
                    error: function(xhr,status,e){
                            alert("error");
                    }
                });
            }

            // 사용자 정보 조회 모달 오픈
            function userModalOpen(){
                setUserModalData();       // API 응답 받고 나서 모달 열림
            }
            function userModalClose(){
                $("#userModal").modal("hide");
            }

            // 사용자 모달 값(이름, ID, 비밀번호) 셋팅 함수
            function setUserModalData(){

                console.log("setUserModalData() 호출");

                // 사용자 정보 조회 URI
                let uri = 'https://3fpdmaspi2.execute-api.ap-northeast-2.amazonaws.com/pet/devices/MKR2%7D/user';       

                $.ajax(uri, {
                    method: 'GET',
                    contentType: "application/json",

                    success: function (data, status, xhr) {
                            var result = JSON.parse(data);
                            console.log(result);

                            let now_name = result.name;
                            let now_id = result.id;
                            let now_password = result.password;

                            $('#td_name').text(now_name);
                            $('#td_id').text(now_id);
                            $('#td_password').text(now_password);

                            $("#userModal").modal("show");
                    },
                    error: function(xhr,status,e){
                            alert("error");
                    }
                });
            }
        </script>
			
    </body>
</html>